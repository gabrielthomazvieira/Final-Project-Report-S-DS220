---
title: "S&DS 220 Final Project Report"
author: "Gabriel Thomas Vieira, Pranava Dhar, Adin Ring"
date: "4/21/2022"
output:
  pdf_document: default
  html_document:
    df_print: paged
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo   =FALSE,      ## show or suppress the code
                      include=TRUE ,      ## show or suppress the output
                      message=FALSE,      ## omit messages generated by code
                      warning=FALSE,      ## omit warnings generated by code
                      comment=NA,         ## removes the ## from in front of outputs
                      fig.align="center", ## centers all figures
                      fig.height = 5,     ## set the default height
                      fig.weight = 5      ## set the default width
                      )
library(tidyverse)
library(GGally)
library(ggtext)
library(lubridate)
library(textreadr)
library(rvest)
```

## Data exploration and visualization

### Scrapping Data

The code to scrape NBA Game data from Basketball Reference was adopted from <https://www.r-bloggers.com/2018/12/scraping-nba-game-data-from-basketball-reference-com/.> We modified the script to use it for the seasons from 2019 to 2022. The process involved changing the monthList for certain seasons, as 2020 and 2021 had unusual timelines

```{r}
##Parameters
year <- "2019"
monthList <- c("october", "november", "december", "january", "february", 
               "march", "april", "may", "june")

# We modified months depending on season; had to manually check the website
playoff_startDate <- ymd("2019-04-13")

## Modified Playoff Start date depending on season
outputfile <- "NBA-2019_game_data.csv"

df <- data.frame()
for (month in monthList) {
    # get webpage
    url <- paste0("https://www.basketball-reference.com/leagues/NBA_", year, 
                  "_games-", month, ".html")
    webpage <- read_html(url)
    
    # get column names
    col_names <- webpage %>% 
        html_nodes("table#schedule > thead > tr > th") %>% 
        html_attr("data-stat")    
    col_names <- c("game_id", col_names)
    
    # extract dates column
    # note that in april, there is a break in the table which just says 
    # "Playoffs". this messes with the data merging later, so we get rid of it
    dates <- webpage %>% 
        html_nodes("table#schedule > tbody > tr > th") %>% 
        html_text()
    dates <- dates[dates != "Playoffs"]
    
    # extract game id
    # we need to remove the NA that is due to the "Playoffs" row in april
    game_id <- webpage %>% 
        html_nodes("table#schedule > tbody > tr > th") %>%
        html_attr("csk")
    game_id <- game_id[!is.na(game_id)]
    
    # extract all columns (except date)
    data <- webpage %>% 
        html_nodes("table#schedule > tbody > tr > td") %>% 
        html_text() %>%
        matrix(ncol = length(col_names) - 2, byrow = TRUE)
    
    # combine game IDs, dates and columns in dataframe for this month, add col names
    month_df <- as.data.frame(cbind(game_id, dates, data), stringsAsFactors = FALSE)
    names(month_df) <- col_names
    
    # add to overall dataframe
    df <- rbind(df, month_df)
}

# change columns to the correct types
df$visitor_pts <- as.numeric(df$visitor_pts)
df$home_pts    <- as.numeric(df$home_pts)
df$attendance  <- as.numeric(gsub(",", "", df$attendance))
df$date_game   <- mdy(df$date_game)

# add column to indicate if regular season or playoff
df$game_type <- with(df, ifelse(date_game >= playoff_startDate, 
                                "Playoff", "Regular"))

# remove undesired columns
df$box_score_text <- NULL
df$game_remarks <- NULL
```

```{r}
# output file as csv
write.csv(df,file.path("data", outputfile), row.names = FALSE)
```

```{r}
# merge csv files for 2019-2022 seasons together into a single dataframe
df <- list.files(path="data", full.names = TRUE) %>% 
  lapply(read_csv) %>% 
  bind_rows 
  head(df)
```

```{r}
write.csv(df, file.path("data", "data_2019-2022.csv"), row.names = FALSE)
```

### Data Cleaning

To clean the data and prepare for modelling, we separate each game into 2 rows: one for the home team and one for the away team. We also calculate an attendance percentage to use instead of the raw attendance data to account for differently-sized stadiums. Finally, we calculate the days rest since the last game each team has played, and then produce a rest differential between the teams in each match-up. When calculating rest, we replace rest times longer than 10 days (i.e. between seasons) with 10, assuming that rest longer than 10 days will not appreciably affect game results. This is done for every game in the 2019-2020 and 2020-2021 seasons, and all games up to present in the 2021-2022 season.

```{r}
# read in data
d = read.csv('data_2019-2022.csv')

# convert date_game column from strings into Date objects and remove X and game_id
d = d %>% 
  mutate(date_game = as.Date(date_game, format = "%Y-%m-%d")) %>%
  mutate(X = NULL, game_id = NULL)

# change column names & add another variable for home or away
d = d %>% 
  rename(team_name = home_team_name) %>%
  rename(team_pts = home_pts) %>%
  rename(opponent_name = visitor_team_name) %>%
  rename(opponent_pts = visitor_pts) %>%
  mutate(away0_home1 = 1)

# add another row for each game and sort by date
d = d %>%
  mutate(game_id = 1:nrow(d))

for(x in 1:nrow(d)) {
  d = d %>%
    add_row(date_game = d$date_game[x], 
            game_id = x,
            game_start_time = d$game_start_time[x],
            opponent_name = d$team_name[x],
            opponent_pts = d$team_pts[x],
            team_name = d$opponent_name[x],
            team_pts = d$opponent_pts[x],
            overtimes = d$overtimes[x],
            attendance = d$attendance[x],
            game_type = d$game_type[x],
            away0_home1 = 0)
}
d = d %>% arrange(date_game)

# change away0_home1 to 0.5 for the bubble games
d = d %>% 
  mutate(away0_home1 = ifelse(attendance == 0 | is.na(attendance), .5, away0_home1))

# calculate attendance percentage 
d = d %>% 
  mutate(attendance = ifelse(attendance==0, NA, attendance)) %>% 
  group_by(team_name) %>% 
  mutate(attendance.perc = away0_home1*(attendance/max(attendance, na.rm = TRUE)))

head(d)
```

```{r}
# add new empty column rest_time based off time since last game
d = d %>% 
  mutate(rest_time = 0)

d1 = data.frame(matrix(nrow = 0, ncol = length(colnames(d)) ))
colnames(d1) = colnames(d)
                

# loop through each team and fill in rest_time
teams = unique(d$team_name)
for(team in teams) {
  teamGames = d %>% filter(team_name == team)
  
  difference = diff(as.matrix(teamGames$date_game))
  rest = ifelse(difference>10, 10, difference)
  
  teamGames$rest_time = c(NA,rest)
  
  d1 = rbind(d1, teamGames)
}
```

```{r}
# find rest differential for each game 
d1 = d1 %>% 
  arrange(game_id) %>%
  mutate(rest_diff = NA)
head(d1)

for(x in 1:(nrow(d1)/2)) {
  game1 = 2*x - 1
  game2 = 2*x
  rd1 = d1$rest_time[game1] - d1$rest_time[game2]
  rd2 = -1 * rd1
  d1$rest_diff[game1] = rd1
  d1$rest_diff[game2] = rd2
}
```

```{r}
write.csv(d1,file.path("data","4.27.2022_cleaned_data.csv"))
```

### Data Visualization

With our data properly cleaned, we can now explore any interesting relationships in our data. First, we'll use the `ggtext` package to add team logos to our plots to make it easier to distinguish between teams.

```{r}
labels <- c(
  Atlanta.Hawks = "<img src = 'teams_logos/hawks.png' width = '50' /><br>Atlanta.Hawks",
  Boston.Celtics = "<img src = 'teams_logos/celtics.png' width = '50' /><br>oston.Celtics",
  Brooklyn.Nets = "<img src = 'teams_logos/nets.png' width = '50' /><br>Brooklyn.Nets",
  Charlotte.Hornets = "<img src = 'teams_logos/hornets.png' width = '50' /><br>Charlotte.Hornets",
  Chicago.Bulls = "<img src = 'teams_logos/bulls.png' width = '50' /><br>Chicago.Bulls",
  Cleveland.Cavaliers = "<img src = 'teams_logos/cavaliers.png' width = '50' /><br>Cleveland.Cavaliers",
  Dallas.Mavericks = "<img src = 'teams_logos/mavericks.png' width = '50' /><br>Dallas.Mavericks",
  Denver.Nuggets = "<img src = 'teams_logos/nuggets.png' width = '50' /><br>Denver.Nuggets",
  Detroit.Pistons = "<img src = 'teams_logos/pistons.png' width = '50' /><br>Detriot.Pistons",
  Golden.State.Warriors = "<img src = 'teams_logos/warriors.png' width = '50' /><br>Golden.State.Warriors",
  Houston.Rockets = "<img src = 'teams_logos/rockets.png' width = '50' /><br>Houston.Rockets",
  Indiana.Pacers = "<img src = 'teams_logos/pacers.png' width = '50' /><br>Indiana.Pacers",
  Los.Angeles.Clippers = "<img src = 'teams_logos/clippers.png' width = '50' /><br>Los.Angeles.Clippers",
  Los.Angeles.Lakers = "<img src = 'teams_logos/lakers.png' width = '50' /><br>Los.Angeles.Lakers",
  Memphis.Grizzlies = "<img src = 'teams_logos/grizzlies.png' width = '50' /><br>Memphis.Grizzlies",
  Miami.Heat = "<img src = 'teams_logos/heat.png' width = '50' /><br>Miami.Heat",
  Milwaukee.Bucks = "<img src = 'teams_logos/bucks.png' width = '50' /><br>Milwaukee.Bucks",
  Minnesota.Timberwolves = "<img src = 'teams_logos/timberwolves.png' width = '50' /><br>Minnesota.Timberwolves",
  New.Orleans.Pelicans = "<img src = 'teams_logos/pelicans.png' width = '50' /><br>New.Orleans.Pelicans",
  New.York.Knicks = "<img src = 'teams_logos/knicks.png' width = '50' /><br>New.York.Knicks",
  Oklahoma.City.Thunder = "<img src = 'teams_logos/thunder.png' width = '50' /><br>Oklahoma.City.Thunder",
  Orlando.Magic = "<img src = 'teams_logos/magic.png' width = '50' /><br>Orlando.Magic",
  Philadelphia.76ers = "<img src = 'teams_logos/76ers.png' width = '50' /><br>Philadelphia.76ers",
  Phoenix.Suns = "<img src = 'teams_logos/suns.png' width = '50' /><br>Phoenix.Suns",
  Portland.Trail.Blazers = "<img src = 'teams_logos/blazers.png' width = '50' /><br>Portland.Trail.Blazers",
  Sacramento.Kings = "<img src = 'teams_logos/kings.png' width = '50' /><br>Sacramento.Kings",
  San.Antonio.Spurs = "<img src = 'teams_logos/spurs.png' width = '50' /><br>San.Antonio.Spurs",
  Toronto.Raptors = "<img src = 'teams_logos/raptors.png' width = '50' /><br>Toronto.Raptors",
  Utah.Jazz = "<img src = 'teams_logos/jazz.png' width = '50' /><br>Utah.Jazz",
  Washington.Wizards = "<img src = 'teams_logos/wizards.png' width = '50' /><br>Washington.Wizards")
```

We will start by plotting a simple histogram of all team's points to get a better idea of the data we are dealing with.

```{r}
hist(d1$team_pts)
mean(d1$team_pts, na.rm=TRUE)
sd(d1$team_pts, na.rm=TRUE)
```

Team's points appear to be approximately normally distributed, with mean 111.29 and standard deviation 12.51. This is a great sign given our large sample and it is what we would expect from the Central Limit Theorem. Now, what about individual teams? Do any teams stand out from the rest in terms of scoring? Which teams are the least consistent? Let's see which teams have the highest points per game average:

```{r}
by_team <- d1 %>% 
  group_by(team_name) %>%
  summarise(mean_pts=mean(team_pts, na.rm=TRUE),
            st_dev=sd(team_pts, na.rm=TRUE),
            opp_pts=mean(opponent_pts, na.rm=TRUE)) %>% 
  arrange(desc(mean_pts))
  
head(by_team)

by_team <- by_team %>% 
  arrange(desc(st_dev))

head(by_team)
```

As we can see, the Milwaukee Bucks have the highest points per game average over the past three seasons, followed by the Phoenix Suns, Memphis Grizzlies, Brooklyn Nets, Minnesota Timberwolves, and the Utah Jazz. We might expect these teams to have the best offensive ratings in the league in our model. We can also see that the Los Angeles Clippers had the highest standard deviation among all teams, followed by the Wizards, Rockets, Hornets, Celtics, and Trail Blazers. Some of these teams are known to be inconsistent between games (e.g., Los Angeles Clippers), specially during playoffs, and others went through massive trades (e.g., Houston Rockets). These high standard deviations help us understand these nuances. This high inconsistency is expected to hurt these teams' standings in the power ranking.

We can also follow the same procedure for `opponent_pts`, which will allow us to understand each teams' defensive abilities. 

```{r}
by_team <- by_team %>% 
  arrange(opp_pts)

head(by_team)

by_team <- by_team %>% 
  arrange(desc(opp_pts))

head(by_team)
```

As we can see, the Boston Celtics have the lowest opponent points per game average over the past three seasons, followed by the Heat, Knicks, 76ers, Raptos, and Jazz. We might expect these teams to have the best defeensive ratings in the league in our model. Conversely, the Washington Wizards had the highest opponent points per game average over the past three seasons.

Now, let's try looking at some other variables. We usually hear about how playing at home gives the home team an advantage. We can plot the difference between points scored at home and away on average to see how these vary among teams and if that's the case for all of them.

```{r}
home <- d1 %>% 
  group_by(team_name) %>% 
  filter(away0_home1==1) %>% 
  summarise(mean_home=mean(team_pts, na.rm = TRUE))

away <- d1 %>% 
  group_by(team_name) %>% 
  filter(away0_home1==0) %>% 
  summarise(mean_away=mean(team_pts, na.rm = TRUE))

mean_away_home <- merge(away,home)
mean_away_home$diff = home$mean_home - away$mean_away
mean_away_home$team_name <- make.names(mean_away_home[,1])

ggplot(mean_away_home, aes(x= reorder(team_name,diff), y=diff))+
  geom_col()+
  labs(title = 'Difference between mean of points scored at home and away games by each team', subtitle = 'Positive values indicate that teams scores more at home, while negative values mean that teams score more away.',y='Points difference between home and away games')+
  scale_x_discrete(name = NULL,
                   labels = labels) +
  theme(axis.text.x = ggtext::element_markdown(size = 0.20))
```
There appears to be a trend towards teams playing better at home, but it is not a rule across all teams. There is also a considerable variation across some teams. While a team playing better at home or away does not necessarily imply anything about it's ability, these deviations among teams show that playing at home or away might be able to influence the outcome of a game by a couple of points, which may be decisive in an tough game.

We can also plot a histogram of `rest_diff` to see if some games occur with a considerable difference between each teams' rest.

```{r}
hist(d1$rest_diff)
```
`rest_diff` seems roughly normally distributed, with not much deviation. Most games seem to be played with both teams having about the same rest time. Nonetheless, there are some variations that might show up when we create our model. We will now do the same thing for `attendance.perc`.

```{r}
hist(d1$attendance.perc)
```
Recall that all away games have `attendance.perc` set to 0, as we assume it should only matter for home games. We can see some interesting variations in our data. While some games are played in nearly full stadiums, others have less than 20% attendance. Although this histogram by itself does not tell us anything about the importance of this variable in our model, it might have potential to become an interesting predictor if these differences in attendance prove to be related to scoring.